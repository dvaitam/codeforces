package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strconv"
	"strings"
)

var rawTestcases = []string{
	"906691060 403959 1198732 441003",
	"43469774 271494 807605 509534",
	"434794719 962839 1784712 318048",
	"511742082 375442 987163 229055",
	"541903390 146040 441569 73269",
	"811538591 99438 747845 262676",
	"976832603 558434 1297861 631142",
	"968693315 154101 479315 51782",
	"783650879 77325 1019826 891788",
	"734422155 346237 841315 293505",
	"108127102 370978 826241 165780",
	"655934895 671533 1628895 214412",
	"593267778 500182 964380 453673",
	"559799207 273146 338451 52760",
	"986194170 575353 1535843 14725",
	"100149904 754666 1635566 418198",
	"762628806 864913 1688096 700611",
	"671374074 1199 642820 517555",
	"889126175 909748 1259066 127881",
	"784130655 341002 1078825 66045",
	"205156724 961565 1556644 232475",
	"256211902 842369 991786 142343",
	"481003666 95647 180001 41952",
	"939617817 532615 1510763 513056",
	"117099973 316090 894136 305232",
	"758664544 130874 704908 348916",
	"874527132 967049 1533578 213074",
	"858378322 632486 1206299 301632",
	"477803330 96084 721337 403600",
	"340426464 603614 857482 76110",
	"197427542 198592 1059963 195802",
	"35403864 642540 1331098 272690",
	"511671264 72442 166630 88963",
	"813471023 136551 1055912 156816",
	"991472819 40519 923903 84148",
	"964406046 733294 1701217 869649",
	"580464751 716701 1127005 369773",
	"563256981 289024 836161 246943",
	"912128613 225655 1164172 712482",
	"633294197 865352 1861253 439799",
	"622442781 288580 761030 258295",
	"708933077 672344 1406584 374729",
	"88447325 340080 982630 120954",
	"522315486 615593 1276351 351558",
	"907395137 199627 454469 4251",
	"785430573 284204 407029 92451",
	"236717702 390134 1223315 178765",
	"357057976 446831 1302378 65215",
	"108026500 821160 974628 57352",
	"48569709 856813 1458556 560149",
	"646575639 713650 791242 3501",
	"133620429 665846 863525 158949",
	"891298200 603931 729441 51278",
	"98281581 388120 1262470 121685",
	"39075653 634918 657606 6378",
	"198612107 752997 882911 62816",
	"226104807 762478 1602122 64054",
	"729443502 23890 594563 446295",
	"666364151 106431 982939 272547",
	"75166547 231557 307025 39462",
	"376125287 457252 646330 16003",
	"540775580 489823 531115 39093",
	"108363357 733294 1143577 104521",
	"279315954 375973 1324304 767138",
	"504890753 879050 1825185 597447",
	"181918285 731589 1436904 213297",
	"823934010 60871 887829 709050",
	"169875224 886492 1056314 89737",
	"568518619 262865 385772 78224",
	"989365467 463800 1161739 183313",
	"14177428 494536 1208911 429818",
	"966472924 596758 1514058 533307",
	"985170072 326575 1007032 374502",
	"417301432 878352 1567913 263123",
	"164725705 587832 1312213 13042",
	"491724583 777598 860513 44031",
	"793512519 47917 618678 294529",
	"144780778 251795 1050985 505234",
	"378199319 639774 941636 188326",
	"633805836 992903 1928174 664534",
	"916733262 651247 790021 81344",
	"416630334 784845 1219394 341225",
	"86675784 1599 625059 201653",
	"750097452 350646 518502 62763",
	"239549458 668362 1138266 198522",
	"762732478 917948 1624453 595751",
	"939027650 434537 467615 26364",
	"935968070 735922 1330960 438544",
	"829128097 694363 1437810 49054",
	"177892146 466986 533976 33979",
	"753247254 165347 633395 276602",
	"950203008 510936 1463085 588677",
	"648515781 792184 792257 6",
	"531054100 341777 668994 244787",
	"53533540 848347 1711032 851880",
	"445750407 197134 772344 87523",
	"899203368 760799 897661 3863",
	"431447526 995673 1707148 437766",
	"339492619 3558 227455 3748",
	"770220931 791417 793890 2166",
}

func maxT(l, r, k int64) int64 {
	ans := int64(1)
	t := int64(1)
	lm1 := l - 1
	for t <= r {
		ur := r / t
		ul := lm1 / t
		cnt := ur - ul
		next1 := r/ur + 1
		var next2 int64
		if ul > 0 {
			next2 = lm1/ul + 1
		} else {
			next2 = r + 1
		}
		next := next1
		if next2 < next {
			next = next2
		}
		if cnt >= k {
			cand := next - 1
			if cand > ans {
				ans = cand
			}
		}
		t = next
	}
	return ans
}

func fibMod(n, mod int64) int64 {
	var rec func(n int64) (int64, int64)
	rec = func(n int64) (int64, int64) {
		if n == 0 {
			return 0, 1
		}
		a, b := rec(n >> 1)
		t1 := (2*b - a) % mod
		if t1 < 0 {
			t1 += mod
		}
		c := (a * t1) % mod
		d := (a*a + b*b) % mod
		if n&1 == 0 {
			return c, d
		}
		return d, (c + d) % mod
	}
	f, _ := rec(n)
	return f % mod
}

func expected(m, l, r, k int64) int64 {
	t := maxT(l, r, k)
	return fibMod(t, m)
}

func runCase(bin string, m, l, r, k int64) error {
	input := fmt.Sprintf("%d %d %d %d\n", m, l, r, k)
	cmd := exec.Command(bin)
	cmd.Stdin = strings.NewReader(input)
	var out bytes.Buffer
	cmd.Stdout = &out
	cmd.Stderr = &out
	if err := cmd.Run(); err != nil {
		return fmt.Errorf("runtime error: %v\n%s", err, out.String())
	}
	outStr := strings.TrimSpace(out.String())
	got, err := strconv.ParseInt(outStr, 10, 64)
	if err != nil {
		return fmt.Errorf("failed to parse output: %v", err)
	}
	exp := expected(m, l, r, k)
	if got != exp {
		return fmt.Errorf("expected %d got %d", exp, got)
	}
	return nil
}

func main() {
	if len(os.Args) != 2 {
		fmt.Fprintln(os.Stderr, "usage: go run verifierC.go /path/to/binary")
		os.Exit(1)
	}
	bin := os.Args[1]
	for idx, line := range rawTestcases {
		parts := strings.Fields(strings.TrimSpace(line))
		if len(parts) != 4 {
			fmt.Fprintf(os.Stderr, "test %d: invalid line\n", idx+1)
			os.Exit(1)
		}
		mVal, _ := strconv.ParseInt(parts[0], 10, 64)
		lVal, _ := strconv.ParseInt(parts[1], 10, 64)
		rVal, _ := strconv.ParseInt(parts[2], 10, 64)
		kVal, _ := strconv.ParseInt(parts[3], 10, 64)
		if err := runCase(bin, mVal, lVal, rVal, kVal); err != nil {
			fmt.Fprintf(os.Stderr, "case %d failed: %v\n", idx+1, err)
			os.Exit(1)
		}
	}
	fmt.Printf("All %d tests passed\n", len(rawTestcases))
}
