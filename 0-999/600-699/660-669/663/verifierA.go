package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strconv"
	"strings"
)

// Embedded testcases from testcasesA.txt.
const embeddedTestcasesA = `? - ? + ? - ? - ? - ? - ? - ? - ? + ? + ? - ? + ? = 49
? - ? + ? - ? = 40
? + ? - ? - ? = 47
? - ? - ? - ? + ? - ? - ? - ? + ? + ? + ? - ? + ? - ? - ? + ? - ? + ? = 7
? + ? + ? + ? - ? + ? + ? = 37
? - ? + ? - ? - ? + ? - ? + ? - ? - ? + ? = 33
? - ? + ? - ? + ? + ? + ? + ? - ? - ? + ? + ? + ? + ? + ? + ? - ? - ? + ? + ? = 25
? - ? - ? - ? - ? + ? - ? + ? - ? - ? + ? + ? + ? - ? + ? + ? - ? + ? - ? = 27
? + ? + ? + ? + ? + ? + ? + ? + ? + ? - ? + ? - ? + ? = 4
? + ? = 39
? + ? - ? + ? + ? + ? - ? = 12
? - ? + ? + ? + ? - ? - ? - ? + ? + ? - ? + ? + ? - ? + ? - ? - ? - ? + ? + ? = 7
? + ? = 44
? - ? + ? - ? + ? + ? = 22
? - ? - ? - ? - ? - ? + ? + ? - ? + ? - ? + ? - ? + ? + ? - ? = 44
? - ? - ? + ? - ? - ? - ? + ? + ? + ? - ? + ? = 40
? - ? - ? - ? + ? - ? - ? + ? = 15
? + ? - ? + ? - ? - ? = 29
? + ? + ? - ? - ? - ? - ? + ? - ? + ? + ? + ? + ? - ? - ? - ? + ? + ? = 39
? = 46
? = 44
? + ? + ? + ? + ? - ? - ? + ? + ? - ? - ? + ? + ? - ? - ? + ? - ? = 40
? - ? + ? + ? - ? = 42
? = 3
? - ? = 14
? - ? + ? - ? - ? - ? - ? + ? + ? - ? - ? + ? + ? + ? - ? - ? - ? - ? = 21
? + ? + ? = 22
? + ? - ? - ? - ? + ? - ? + ? - ? = 11
? - ? + ? + ? - ? - ? - ? - ? = 4
? + ? - ? - ? - ? - ? + ? - ? + ? - ? - ? + ? - ? - ? = 7
? - ? + ? + ? + ? = 11
? + ? + ? - ? + ? + ? - ? = 48
? - ? - ? - ? + ? - ? + ? - ? + ? - ? + ? - ? + ? - ? + ? + ? + ? - ? = 34
? - ? - ? - ? + ? + ? + ? = 8
? + ? + ? - ? - ? - ? + ? + ? - ? + ? - ? - ? - ? - ? - ? - ? + ? + ? + ? - ? = 10
? + ? + ? - ? + ? - ? - ? - ? + ? + ? + ? = 21
? + ? + ? = 15
? - ? - ? + ? + ? - ? - ? - ? + ? + ? = 1
? + ? - ? + ? - ? - ? - ? - ? + ? + ? + ? + ? - ? - ? - ? + ? - ? = 49
? - ? - ? - ? + ? + ? + ? + ? - ? = 20
? + ? - ? - ? + ? - ? + ? + ? - ? - ? + ? = 4
? - ? - ? + ? + ? - ? + ? + ? + ? + ? - ? + ? - ? + ? - ? - ? + ? + ? - ? - ? = 30
? - ? + ? - ? = 44
? + ? + ? + ? - ? - ? - ? + ? - ? - ? = 48
? + ? - ? = 3
? + ? + ? + ? - ? - ? + ? + ? - ? = 2
? + ? + ? - ? + ? + ? - ? + ? + ? - ? - ? - ? + ? - ? - ? - ? + ? - ? + ? = 28
? + ? - ? - ? = 23
? + ? - ? + ? + ? + ? = 1
? = 14
? + ? - ? - ? = 48
? = 39
? + ? - ? + ? - ? - ? - ? + ? = 10
? = 14
? - ? - ? - ? - ? + ? + ? + ? - ? + ? - ? + ? = 22
? - ? + ? + ? + ? = 15
? - ? + ? + ? + ? - ? + ? + ? + ? - ? = 24
? - ? + ? - ? - ? - ? + ? + ? - ? - ? = 36
? - ? - ? + ? - ? - ? - ? + ? - ? - ? - ? + ? + ? + ? - ? + ? + ? = 4
? + ? - ? - ? + ? + ? - ? - ? + ? - ? - ? + ? - ? + ? - ? = 26
? = 45
? - ? + ? + ? - ? + ? - ? + ? - ? - ? + ? - ? + ? - ? - ? = 40
? = 8
? + ? + ? - ? - ? - ? - ? + ? - ? = 43
? + ? + ? + ? + ? - ? - ? - ? + ? + ? + ? + ? = 19
? - ? + ? + ? + ? - ? - ? - ? - ? - ? - ? + ? + ? + ? = 19
? - ? - ? + ? = 25
? - ? - ? - ? - ? + ? - ? - ? - ? - ? + ? - ? - ? + ? - ? + ? + ? + ? = 43
? - ? + ? + ? + ? - ? + ? - ? + ? + ? + ? - ? = 31
? + ? + ? - ? + ? + ? - ? - ? - ? - ? = 47
? - ? - ? + ? - ? + ? = 22
? + ? + ? + ? - ? - ? - ? - ? - ? - ? + ? + ? - ? + ? + ? - ? + ? = 21
? + ? + ? - ? + ? + ? + ? - ? = 41
? - ? - ? - ? - ? + ? - ? - ? - ? - ? - ? + ? - ? - ? + ? + ? + ? + ? - ? + ? = 6
? + ? + ? + ? - ? + ? - ? + ? - ? + ? = 42
? + ? + ? - ? - ? - ? - ? - ? + ? + ? + ? = 39
? + ? - ? + ? + ? - ? - ? - ? - ? - ? - ? - ? = 6
? - ? + ? + ? - ? - ? - ? + ? = 3
? - ? - ? + ? + ? + ? + ? + ? + ? - ? + ? - ? + ? - ? = 32
? - ? + ? + ? + ? - ? + ? + ? - ? - ? - ? - ? + ? - ? + ? - ? - ? - ? = 49
? - ? - ? + ? + ? + ? + ? + ? - ? + ? + ? - ? + ? - ? + ? + ? - ? - ? = 41
? - ? + ? - ? = 48
? + ? + ? - ? - ? + ? - ? - ? = 48
? + ? + ? + ? - ? - ? + ? + ? - ? + ? = 38
? + ? + ? + ? - ? + ? = 33
? + ? + ? - ? - ? + ? - ? + ? = 47
? - ? - ? - ? - ? + ? + ? + ? - ? - ? - ? + ? - ? + ? - ? + ? - ? - ? - ? + ? = 2
? - ? + ? - ? - ? + ? - ? = 3
? + ? - ? + ? - ? + ? + ? - ? + ? - ? + ? + ? = 43
? + ? + ? - ? + ? + ? - ? - ? = 3
? - ? - ? + ? - ? = 14
? - ? - ? - ? + ? - ? - ? - ? + ? + ? = 12
? + ? + ? + ? + ? + ? - ? + ? + ? + ? + ? + ? + ? + ? = 25
? + ? - ? + ? + ? - ? - ? - ? + ? + ? - ? + ? - ? - ? = 39
? + ? - ? + ? - ? = 30
? - ? - ? + ? - ? - ? - ? + ? - ? + ? - ? = 18
? + ? - ? - ? - ? + ? + ? - ? + ? - ? - ? + ? - ? = 47
? + ? + ? - ? + ? - ? + ? + ? - ? + ? + ? + ? - ? = 17
? - ? - ? - ? - ? - ? + ? + ? + ? + ? - ? + ? = 19
? - ? - ? + ? + ? - ? - ? + ? + ? + ? + ? = 1`

func solve663A(expr string) (bool, string) {
	tokens := strings.Fields(expr)
	sgns := []string{"+"}
	i := 0
	for ; i < len(tokens); i++ {
		if tokens[i] == "=" {
			break
		}
		if tokens[i] == "+" || tokens[i] == "-" {
			sgns = append(sgns, tokens[i])
		}
	}
	if i+1 >= len(tokens) {
		return false, ""
	}
	n, err := strconv.Atoi(tokens[i+1])
	if err != nil {
		return false, ""
	}

	st := 1
	for j := 1; j < len(sgns); j++ {
		if sgns[j] == "+" {
			st++
		} else {
			st--
		}
	}
	sol := make([]int, len(sgns))
	for j := range sol {
		sol[j] = 1
	}
	for j := 0; j < len(sgns); j++ {
		if st > n && sgns[j] == "-" {
			if st-n > n-1 {
				sol[j] = n
				st -= n - 1
			} else {
				sol[j] += st - n
				st = n
			}
		}
		if st < n && sgns[j] == "+" {
			if n-st > n-1 {
				sol[j] = n
				st += n - 1
			} else {
				sol[j] += n - st
				st = n
			}
		}
	}
	if st != n {
		return false, ""
	}
	var out strings.Builder
	out.WriteString("Possible\n")
	out.WriteString(strconv.Itoa(sol[0]))
	for j := 1; j < len(sgns); j++ {
		out.WriteByte(' ')
		out.WriteString(sgns[j])
		out.WriteByte(' ')
		out.WriteString(strconv.Itoa(sol[j]))
	}
	out.WriteString(" = ")
	out.WriteString(strconv.Itoa(n))
	return true, out.String()
}

func runCandidate(bin, input string) (string, error) {
	cmd := exec.Command(bin)
	cmd.Stdin = strings.NewReader(input)
	var out bytes.Buffer
	cmd.Stdout = &out
	cmd.Stderr = os.Stderr
	if err := cmd.Run(); err != nil {
		return "", err
	}
	return strings.TrimSpace(out.String()), nil
}

func main() {
	if len(os.Args) != 2 {
		fmt.Println("usage: go run verifierA.go /path/to/binary")
		os.Exit(1)
	}
	bin := os.Args[1]
	lines := strings.Split(strings.TrimSpace(embeddedTestcasesA), "\n")
	for idx, line := range lines {
		ok, want := solve663A(line)
		if !ok {
			fmt.Fprintf(os.Stderr, "case %d: solver failed\n", idx+1)
			os.Exit(1)
		}
		got, err := runCandidate(bin, line+"\n")
		if err != nil {
			fmt.Fprintf(os.Stderr, "case %d failed: %v\n", idx+1, err)
			os.Exit(1)
		}
		if strings.TrimSpace(got) != strings.TrimSpace(want) {
			fmt.Fprintf(os.Stderr, "case %d failed:\nexpected:\n%s\ngot:\n%s\n", idx+1, want, got)
			os.Exit(1)
		}
	}
	fmt.Printf("All %d tests passed\n", len(lines))
}
